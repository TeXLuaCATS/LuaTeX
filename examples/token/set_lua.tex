\directlua{
  local t = lua.get_functions_table()

  t[1] = function () end

  local index = 1
  while t[index] do
    index = index + 1
  end

  t[index] = function(slot)
    print(slot)
  end
  token.set_lua('mycode', index, 'protected', 'global')
}

\mycode

\bye
